services:
  # ---------------------------------------------------------------------------
  # Grafana Pyroscope – continuous profiling backend
  # ---------------------------------------------------------------------------
  pyroscope:
    image: grafana/pyroscope:latest
    container_name: pyroscope
    ports:
      - "${PYROSCOPE_PORT:-4040}:4040"
    volumes:
      - pyroscope-data:/data
      - ./config/pyroscope/pyroscope.yaml:/etc/pyroscope/config.yaml
    command:
      - "-config.file=/etc/pyroscope/config.yaml"
    networks:
      - monitoring

  # ---------------------------------------------------------------------------
  # Prometheus – metrics collection
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yaml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./config/prometheus/prometheus.yaml:/etc/prometheus/prometheus.yaml
      - ./config/prometheus/alerts.yaml:/etc/prometheus/alerts.yaml
      - prometheus-data:/prometheus
    networks:
      - monitoring

  # ---------------------------------------------------------------------------
  # Grafana – dashboards & visualisation
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:11.5.2
    container_name: grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-pyroscope-app,grafana-llm-app
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - pyroscope
    networks:
      - monitoring

  # ---------------------------------------------------------------------------
  # Bank Enterprise Services — each runs a different Verticle.
  # All use the same Docker image; VERTICLE env var selects the class.
  #
  # Pyroscope agent config:
  #   Shared settings  → config/pyroscope/pyroscope.properties (mounted read-only)
  #   Per-service name → PYROSCOPE_APPLICATION_NAME env var
  #   Per-service label → PYROSCOPE_LABELS env var
  #   Agents attached  → JAVA_TOOL_OPTIONS (javaagent flags only)
  # ---------------------------------------------------------------------------

  # API Gateway / general workloads (MainVerticle)
  api-gateway:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "${API_GATEWAY_PORT:-8080}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      PYROSCOPE_APPLICATION_NAME: bank-api-gateway
      PYROSCOPE_LABELS: env=production,service=api-gateway
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # Order / Trade Service (OrderVerticle)
  order-service:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: order-service
    ports:
      - "${ORDER_SERVICE_PORT:-8081}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: order
      PYROSCOPE_APPLICATION_NAME: bank-order-service
      PYROSCOPE_LABELS: env=production,service=order-service
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # Payment Processing Service (PaymentVerticle)
  payment-service:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - "${PAYMENT_SERVICE_PORT:-8082}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: payment
      PYROSCOPE_APPLICATION_NAME: bank-payment-service
      PYROSCOPE_LABELS: env=production,service=payment-service
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # Fraud Detection Service (FraudDetectionVerticle)
  fraud-service:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: fraud-service
    ports:
      - "${FRAUD_SERVICE_PORT:-8083}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: fraud
      PYROSCOPE_APPLICATION_NAME: bank-fraud-service
      PYROSCOPE_LABELS: env=production,service=fraud-service
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # Core Accounts Service (AccountVerticle)
  account-service:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: account-service
    ports:
      - "${ACCOUNT_SERVICE_PORT:-8084}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: account
      PYROSCOPE_APPLICATION_NAME: bank-account-service
      PYROSCOPE_LABELS: env=production,service=account-service
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # Loan Origination Service (LoanVerticle)
  loan-service:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: loan-service
    ports:
      - "${LOAN_SERVICE_PORT:-8085}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: loan
      PYROSCOPE_APPLICATION_NAME: bank-loan-service
      PYROSCOPE_LABELS: env=production,service=loan-service
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # Notification Service (NotificationVerticle)
  notification-service:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "${NOTIFICATION_SERVICE_PORT:-8086}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: notification
      PYROSCOPE_APPLICATION_NAME: bank-notification-service
      PYROSCOPE_LABELS: env=production,service=notification-service
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # Stream Processing Service (StreamVerticle)
  stream-service:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: stream-service
    ports:
      - "${STREAM_SERVICE_PORT:-8087}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: stream
      PYROSCOPE_APPLICATION_NAME: bank-stream-service
      PYROSCOPE_LABELS: env=production,service=stream-service
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

  # FaaS Server (FaasVerticle)
  faas-server:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: faas-server
    ports:
      - "${FAAS_SERVICE_PORT:-8088}:8080"
    volumes:
      - ./config/pyroscope/pyroscope.properties:/opt/pyroscope/pyroscope.properties:ro
    environment:
      VERTICLE: faas
      PYROSCOPE_APPLICATION_NAME: bank-faas-server
      PYROSCOPE_LABELS: env=production,service=faas-server
      PYROSCOPE_CONFIGURATION_FILE: /opt/pyroscope/pyroscope.properties
      JAVA_TOOL_OPTIONS: >-
        -javaagent:/opt/pyroscope/pyroscope.jar
        -javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=9404:/opt/jmx-exporter/config.yaml
    depends_on:
      - pyroscope
    networks:
      - monitoring

volumes:
  pyroscope-data:
  prometheus-data:
  grafana-data:

networks:
  monitoring:
    driver: bridge
